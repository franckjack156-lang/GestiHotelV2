rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    /**
     * Vérifier si l'utilisateur est authentifié
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Vérifier si l'utilisateur est propriétaire de la ressource
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * Vérifier si le document utilisateur existe
     */
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    /**
     * Récupérer le rôle de l'utilisateur actuel
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * Vérifier si l'utilisateur est admin ou super_admin
     * Gère le cas où le document utilisateur n'existe pas encore
     */
    function isAdmin() {
      return isAuthenticated() && userExists() && getUserRole() in ['admin', 'super_admin'];
    }

    /**
     * Vérifier si l'utilisateur est super_admin
     * Gère le cas où le document utilisateur n'existe pas encore
     */
    function isSuperAdmin() {
      return isAuthenticated() && userExists() && getUserRole() == 'super_admin';
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    
    match /users/{userId} {
      // LECTURE :
      // - Soi-même peut TOUJOURS lire son profil (priorité absolue, sans autres vérifications)
      // - Tout utilisateur authentifié peut lire les autres profils (simplifié pour éviter les boucles)
      // Note: Le filtrage par établissement se fait côté application
      allow read: if isAuthenticated();
      
      // CRÉATION :
      // - ⚠️ IMPORTANT : Permettre la création lors du signup (userId == auth.uid)
      // - Admins peuvent créer des utilisateurs
      allow create: if isAuthenticated() && (
        isOwner(userId) ||  // ← CRITIQUE : Permet la création de son propre profil
        isAdmin()
      );
      
      // MISE À JOUR :
      // - Soi-même peut mettre à jour son profil (sauf le rôle)
      // - Admins peuvent tout mettre à jour
      allow update: if isAuthenticated() && (
        (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'establishmentIds'])) ||
        isAdmin()
      );
      
      // SUPPRESSION :
      // - Seuls les admins peuvent supprimer (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ESTABLISHMENTS COLLECTION
    // ============================================================================

    match /establishments/{establishmentId} {
      allow read: if isAuthenticated();
      allow create: if isSuperAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();

      // Interventions subcollection
      match /interventions/{interventionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();

        // Sous-collections des interventions

        // Photos
        match /photos/{photoId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if isAuthenticated();
          allow delete: if isAuthenticated();
        }

        // Comments (sous-collection)
        match /comments/{commentId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if isAuthenticated() && (
            isOwner(resource.data.authorId) ||
            isAdmin()
          );
          allow delete: if isAuthenticated() && (
            isOwner(resource.data.authorId) ||
            isAdmin()
          );
        }

        // Parts (pièces)
        match /parts/{partId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if isAuthenticated();
          allow delete: if isAuthenticated();
        }

        // Time Sessions
        match /timeSessions/{sessionId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if isAuthenticated();
          allow delete: if isAuthenticated();
        }

        // History (historique)
        match /history/{historyId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated();
          allow update: if false; // L'historique ne doit pas être modifiable
          allow delete: if isAdmin(); // Seuls les admins peuvent supprimer l'historique
        }
      }

      // Config subcollection (reference lists, settings, etc.)
      match /config/{configDoc} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // Settings subcollection
      match /settings/{settingDoc} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // Stats subcollection
      match /stats/{statDoc} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // Audit subcollection (logs for reference lists changes)
      match /audit/{auditId} {
        allow read: if isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }

      // Intervention Templates subcollection
      match /interventionTemplates/{templateId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Suppliers subcollection
      match /suppliers/{supplierId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Inventory subcollection
      match /inventory/{itemId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Stock Movements subcollection
      match /stockMovements/{movementId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }

      // Room Blockages subcollection
      match /room_blockages/{blockageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }
    }

    // ============================================================================
    // INTERVENTIONS COLLECTION (Legacy - if any exist at root level)
    // ============================================================================

    match /interventions/{interventionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ROOMS COLLECTION
    // ============================================================================
    
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // INVITATIONS COLLECTION
    // ============================================================================
    
    match /invitations/{invitationId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // REFERENCE LISTS COLLECTION
    // ============================================================================

    match /referenceLists/{listId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================
    // COMMENTS COLLECTION
    // ============================================================================

    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update only if owner or admin
      allow update: if isAuthenticated() && (
        isOwner(resource.data.authorId) ||
        isAdmin()
      );
      // Allow delete only if owner or admin
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.authorId) ||
        isAdmin()
      );
    }

    // ============================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================

    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only system/admins can create notifications
      allow create: if isAdmin();
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only admins can delete notifications
      allow delete: if isAdmin();
    }

    // ============================================================================
    // CONVERSATIONS COLLECTION (Messagerie interne)
    // ============================================================================

    match /conversations/{conversationId} {
      // Lecture : Uniquement si l'utilisateur est participant
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participantIds;

      // Création : Tout utilisateur authentifié peut créer une conversation
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participantIds;

      // Mise à jour : Uniquement les participants peuvent mettre à jour
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participantIds;

      // Suppression : Seuls les admins
      allow delete: if isAdmin();
    }

    // ============================================================================
    // MESSAGES COLLECTION (Messagerie interne)
    // ============================================================================

    match /messages/{messageId} {
      // Lecture : Uniquement si l'utilisateur est participant de la conversation
      allow read: if isAuthenticated() &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds;

      // Création : Tout utilisateur authentifié peut créer un message
      allow create: if isAuthenticated();

      // Mise à jour : L'auteur du message ou les participants peuvent mettre à jour (pour marquer comme lu)
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds
      );

      // Suppression : L'auteur ou les admins
      allow delete: if isAuthenticated() && (
        request.auth.uid == resource.data.senderId ||
        isAdmin()
      );
    }

    // ============================================================================
    // PRESENCE COLLECTION (Statut en ligne/hors ligne)
    // ============================================================================

    match /presence/{userId} {
      // Lecture : Tous les utilisateurs authentifiés peuvent voir la présence
      allow read: if isAuthenticated();

      // Écriture : Seulement son propre statut
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // ============================================================================
    // AUDIT LOGS COLLECTION (Logs globaux pour actions importantes)
    // ============================================================================

    match /audit-logs/{logId} {
      // Lecture : Uniquement les admins peuvent lire les logs d'audit
      allow read: if isAdmin();

      // Création : Tous les utilisateurs authentifiés peuvent créer des logs
      // (pour tracking des suppressions, modifications importantes, etc.)
      allow create: if isAuthenticated();

      // Mise à jour et suppression : Seuls les super admins
      allow update, delete: if isSuperAdmin();
    }

    // ============================================================================
    // DASHBOARD PREFERENCES COLLECTION
    // ============================================================================

    match /dashboardPreferences/{preferenceId} {
      // Lecture : L'utilisateur peut lire ses propres préférences
      // Format du preferenceId: userId_establishmentId
      allow read: if isAuthenticated() &&
        preferenceId.matches(request.auth.uid + '_.*');

      // Création : L'utilisateur peut créer ses propres préférences
      allow create: if isAuthenticated() &&
        preferenceId.matches(request.auth.uid + '_.*') &&
        request.resource.data.userId == request.auth.uid;

      // Mise à jour : L'utilisateur peut mettre à jour ses propres préférences
      allow update: if isAuthenticated() &&
        preferenceId.matches(request.auth.uid + '_.*') &&
        resource.data.userId == request.auth.uid;

      // Suppression : L'utilisateur peut supprimer ses propres préférences
      allow delete: if isAuthenticated() &&
        preferenceId.matches(request.auth.uid + '_.*') &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // THEME PREFERENCES COLLECTION
    // ============================================================================

    match /themePreferences/{userId} {
      // Lecture : L'utilisateur peut lire ses propres préférences de thème
      allow read: if isAuthenticated() && isOwner(userId);

      // Création : L'utilisateur peut créer ses propres préférences de thème
      allow create: if isAuthenticated() &&
        isOwner(userId) &&
        request.resource.data.userId == request.auth.uid;

      // Mise à jour : L'utilisateur peut mettre à jour ses propres préférences de thème
      allow update: if isAuthenticated() &&
        isOwner(userId) &&
        resource.data.userId == request.auth.uid;

      // Suppression : L'utilisateur peut supprimer ses propres préférences de thème
      allow delete: if isAuthenticated() &&
        isOwner(userId) &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // DEFAULT : Tout le reste est interdit
    // ============================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
