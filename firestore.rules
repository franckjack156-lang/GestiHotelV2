rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    /**
     * Vérifier si l'utilisateur est authentifié
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Vérifier si l'utilisateur est propriétaire de la ressource
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * Récupérer le rôle de l'utilisateur actuel
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    /**
     * Vérifier si l'utilisateur est admin ou super_admin
     */
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }
    
    /**
     * Vérifier si l'utilisateur est super_admin
     */
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    
    match /users/{userId} {
      // LECTURE : 
      // - Soi-même peut lire son profil
      // - Admins peuvent lire tous les profils
      // - Utilisateurs du même établissement peuvent se voir (optionnel)
      allow read: if isAuthenticated() && (
        isOwner(userId) || 
        isAdmin()
      );
      
      // CRÉATION :
      // - ⚠️ IMPORTANT : Permettre la création lors du signup (userId == auth.uid)
      // - Admins peuvent créer des utilisateurs
      allow create: if isAuthenticated() && (
        isOwner(userId) ||  // ← CRITIQUE : Permet la création de son propre profil
        isAdmin()
      );
      
      // MISE À JOUR :
      // - Soi-même peut mettre à jour son profil (sauf le rôle)
      // - Admins peuvent tout mettre à jour
      allow update: if isAuthenticated() && (
        (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'establishmentIds'])) ||
        isAdmin()
      );
      
      // SUPPRESSION :
      // - Seuls les admins peuvent supprimer (soft delete)
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ESTABLISHMENTS COLLECTION
    // ============================================================================

    match /establishments/{establishmentId} {
      allow read: if isAuthenticated();
      allow create: if isSuperAdmin();
      allow update: if isAdmin();
      allow delete: if isSuperAdmin();

      // Interventions subcollection
      match /interventions/{interventionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }

      // Config subcollection (reference lists, settings, etc.)
      match /config/{configDoc} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // Audit subcollection (logs for reference lists changes)
      match /audit/{auditId} {
        allow read: if isAdmin();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin();
      }
    }

    // ============================================================================
    // INTERVENTIONS COLLECTION (Legacy - if any exist at root level)
    // ============================================================================

    match /interventions/{interventionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // ROOMS COLLECTION
    // ============================================================================
    
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // INVITATIONS COLLECTION
    // ============================================================================
    
    match /invitations/{invitationId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // REFERENCE LISTS COLLECTION
    // ============================================================================

    match /referenceLists/{listId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ============================================================================
    // COMMENTS COLLECTION
    // ============================================================================

    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update only if owner or admin
      allow update: if isAuthenticated() && (
        isOwner(resource.data.authorId) ||
        isAdmin()
      );
      // Allow delete only if owner or admin
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.authorId) ||
        isAdmin()
      );
    }

    // ============================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================

    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only system/admins can create notifications
      allow create: if isAdmin();
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only admins can delete notifications
      allow delete: if isAdmin();
    }

    // ============================================================================
    // DEFAULT : Tout le reste est interdit
    // ============================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
